# TCP的三次握手

##  1. IP协议

* `IP`协议是无连接的通信协议，他不会占用两个正在通信的计算机之间的通信线路，这样`IP`就降低了对网络线路的需求，每条线可以同时满足许多不同的计算机之间的通信需要。
* 通过`IP`消息或者其他数据会被分割为较小的独立的包，并通过因特网在计算机之间传送。
* `IP`负责将每个包路由至他的目的地，但`IP`协议没有确认数据包是否按顺序发送或者包是否损坏，所以`IP`数据包是不可靠的，需要由他的上层协议作出控制。

##  2. TCP 三次握手的过程

```
A：您好，我是 A。
B：您好 A，我是 B。
A：您好 B。
```

![TCP三次握手](https://gitee.com/AD-Gai-Code/pic-go/raw/master/202110221650641.png)

![img](https://gitee.com/AD-Gai-Code/pic-go/raw/master/202110221656279.png)

- 首先 B 处于 `LISTEN（监听）`状态，等待客户的连接请求。
- A 向 B 发送连接请求报文，`SYN=1，ACK=0`，选择一个初始的序号 x。
- B 收到连接请求报文，如果同意建立连接，则向 A 发送连接确认报文，`SYN=1，ACK=1`，确认号为 `x+1`，同时也选择一个初始的序号 `y`。
- A 收到 B 的连接确认报文后，还要向 B 发出确认，确认号为 `y+1`，序号为 `x+1`。
- B 收到 A 的确认后，连接建立。

##  3. 为什么要三次握手

**三次握手的目的是建立可靠的通信信道，说到通讯，简单来说就是数据的发送与接收，而三次握手最主要的目的就是双方确认自己与对方的发送与接收是正常的。**

第一次握手：Client 什么都不能确认；Server 确认了对方发送正常，自己接收正常

第二次握手：Client 确认了：自己发送、接收正常，对方发送、接收正常；Server 确认了：对方发送正常，自己接收正常

第三次握手：Client 确认了：自己发送、接收正常，对方发送、接收正常；Server 确认了：自己发送、接收正常，对方发送、接收正常

所以三次握手就能确认双发收发功能都正常，缺一不可。

当然 A 发给 B 的应答之应答也会丢，也会绕路，甚至 B 挂了。按理来说，还应该有个应答之应答之应答，这样下去就没底了。所以四次握手是可以的，四十次都可以，关键四百次也不能保证就真的可靠了。只要双方的消息都有去有回，就基本可以了。

其次，第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

###  3.1 第 2 次握手传回了 ACK，为什么还要传回 SYN？

接收端传回发送端所发送的 `ACK` 是为了告诉客户端，我接收到的信息确实就是你所发送的信号了，这表明从客户端到服务端的通信是正常的。而回传 `SYN` 则是为了建立并确认从服务端到客户端的通信。”

> `SYN` 同步序列编号(Synchronize Sequence Numbers) 是 `TCP/IP` 建立连接时使用的握手信号。在客户机和服务器之间建立正常的 `TCP` 网络连接时，客户机首先发出一个 `SYN` 消息，服务器使用 `SYN-ACK` 应答表示接收到了这个消息，最后客户机再以 `ACK(Acknowledgement）`消息响应。这样在客户机和服务器之间才能建立起可靠的 `TCP` 连接，数据才可以在客户机和服务器之间传递。

