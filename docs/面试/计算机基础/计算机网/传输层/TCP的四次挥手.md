#  TCP 的四次挥手

[(45条消息) 两张动图-彻底明白TCP的三次握手与四次挥手_qzcsu的博客-CSDN博客_三次握手四次挥手详解](https://blog.csdn.net/qzcsu/article/details/72861891)

##  TCP 四次挥手的过程

```
A：老师，下课了。
B：好，我知道了，我说完这点。
B：好了，说完了，下课吧。
A：谢谢老师，老师再见。
```



![TCP四次挥手](https://gitee.com/AD-Gai-Code/pic-go/raw/master/202110221718880.png)

![img](https://gitee.com/AD-Gai-Code/pic-go/raw/master/202110221719391.jpeg)

- 客户端-发送一个 FIN，用来关闭客户端到服务器的数据传送
- 服务器-收到这个 FIN，它发回一 个 ACK，确认序号为收到的序号加 1 。和 SYN 一样，一个 FIN 将占用一个序号
- 服务器-关闭与客户端的连接，发送一个 FIN 给客户端
- 客户端-发回 ACK 报文确认，并将确认序号设置为收到序号加 1

任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭状态。当另一方也没有数据再发送的时候，则发出连接释放通知，对方确认后就完全关闭了 `TCP` 连接。

##  为什么要四次挥手

客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 `CLOSE-WAIT` 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 `FIN` 连接释放报文。

##  TIME_WAIT 状态

客户端接收到服务器端的 `FIN` 报文后进入此状态，此时并不是直接进入 `CLOSED` 状态，还需要等待一个时间计时器设置的时间 `2MSL`**MSL是Maximum Segment Lifetime，报文最大生存时间**。这么做有两个理由：

- 确保最后一个确认报文能够到达。如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
- 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。

##  为什么建立连接是三次握手，关闭连接确是四次挥手呢？

建立连接的时候， 服务器在`LISTEN`状态下，收到建立连接请求的SYN报文后，把`ACK`和`SYN`放在一个报文里发送给客户端。
而关闭连接时，服务器收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，而自己也未必全部数据都发送给对方了，所以己方可以立即关闭，也可以发送一些数据给对方后，再发送`FIN`报文给对方来表示同意现在关闭连接，因此，己方`ACK`和`FIN`一般都会分开发送，从而导致多了一次。

