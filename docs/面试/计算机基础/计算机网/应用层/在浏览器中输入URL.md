#  在浏览器中输入 url 地址 -> 显示主页的过程



##  打开一个网页，整个过程会使用哪些协议？

![img](https://gitee.com/AD-Gai-Code/pic-go/raw/master/202110251645623.jpeg)总体来说分为以下几个过程:

1. `DNS` 解析
2. `TCP` 连接(三次握手)
3. 发送 `HTTP` 请求(通过`TCP`套接字发送)
4. 服务器处理请求并返回 `HTTP` 报文
5. 浏览器解析渲染页面
6. 连接结束(四次挥手)

##  1.`DNS` 解析

NS解析的过程就是寻找哪台机器上有你需要资源的过程。当你在浏览器中输入一个地址时，例如`www.baidu.com`，其实不是百度网站真正意义上的地址。互联网上每一台计算机的唯一标识是它的`IP`地址，但是`IP`地址并不方便记忆。用户更喜欢用方便记忆的网址去寻找互联网上的其它计算机，也就是上面提到的百度的网址。所以互联网设计者需要在用户的方便性与可用性方面做一个权衡，这个权衡就是一个网址到`IP`地址的转换，这个过程就是`DNS`解析。它实际上充当了一个翻译的角色，实现了网址到`IP`地址的转换。网址到`IP`地址转换的过程是如何进行的?

###  1.1 解析过程

`DNS`解析是一个递归查询的过程。

![DNS解析过程](https://gitee.com/AD-Gai-Code/pic-go/raw/master/202110251638419.png)

上述图片是查找`www.google.com`的`IP`地址过程。首先在本地域名服务器中查询`IP`地址，如果没有找到的情况下，本地域名服务器会向根域名服务器发送一个请求，如果根域名服务器也不存在该域名时，本地域名会向`com`顶级域名服务器发送一个请求，依次类推下去。直到最后本地域名服务器得到`google`的`IP`地址并把它缓存到本地，供下次查询使用。从上述过程中，可以看出网址的解析是一个从右向左的过程: `com -> google.com -> www.google.com`。但是你是否发现少了点什么，根域名服务器的解析过程呢？事实上，真正的网址是`www.google.com.`，并不是我多打了一个`.`，这个`.`对应的就是根域名服务器，默认情况下所有的网址的最后一位都是`.`，既然是默认情况下，为了方便用户，通常都会省略，浏览器在请求`DNS`的时候会自动加上，所有网址真正的解析过程为: `. -> .com -> google.com. -> www.google.com.`。

###  1.2 DNS 优化

了解了`DNS`的过程，可以为我们带来哪些？上文中请求到`google`的`IP`地址时，经历了8个步骤，这个过程中存在多个请求(大多数情况下 `DNS` 使用 `UDP` 进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。)。如果每次都经过这么多步骤，是否太耗时间？如何减少该过程的步骤呢？那就是`DNS`缓存。

####  1.2.1 DNS 缓存

`DNS`存在着多级缓存，从离浏览器的距离排序的话，有以下几种: 浏览器缓存，系统缓存，路由器缓存，`IPS`服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存。

####  1.2.2 DNS 负载均衡

首先思考一个问题：`DNS`返回的`IP`地址是否每次都一样？如果每次都一样是否说明你请求的资源都位于同一台机器上面，那么这台机器需要多高的性能和储存才能满足亿万请求呢？其实真实的互联网世界背后存在成千上百台服务器，大型的网站甚至更多。但是在用户的眼中，它需要的只是处理他的请求，哪台机器处理请求并不重要。`DNS`可以返回一个合适的机器的`IP`给用户，例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等，这种过程就是`DNS`负载均衡，又叫做`DNS`重定向。

##  2. TCP 连接

HTTP 是基于 TCP 协议传输的,客户端与服务器通过三次握手建立起 TCP 连接，具体过程可参考：[TCP的三次握手]()。

##  3. 发送 HTTP 请求(前端 HTTP)

建立了TCP连接之后，发起一个`http`请求,发送`HTTP`请求的过程就是构建`HTTP`请求报文并通过TCP协议中发送到服务器指定端口(`HTTP`协议`80/8080`, `HTTPS`协议`443`)。`HTTP`请求报文是由三部分组成: **请求行**, **请求报头**和**请求正文**。

###  3.1 请求行

格式如下:
`Method Request-URL HTTP-Version CRLF`

```http
eg: GET index.html HTTP/1.1
```

常用的方法有: GET, POST, PUT, DELETE, OPTIONS, HEAD。

####  3.1.1 Get 和 POST 有什么区别？

1. `Http`报文层面：
	* `GET`请求信息放在`URL`，`POST`放在报文体中
	* `GET`请求中一般浏览器对`URL`长度有限制；`POST`请求数据长度无限制

2. 数据库层面：
	* `GET`服务幂等性（对数据库的一次操作和多次操作上一致的）和安全性（没有改变数据库的数据）
	* `POST`不符合幂等性和安全性

3. 其他层面：
	* `GET`可以被缓存，被存储，而`POST`不行
	* `GET`请求的内容会被保存在浏览器中
	* 超过90%的`GET`请求都被`CDN(Content Delivery Network)`缓存了，大大减少`web`服务起器的负担

###  3.2 请求报头

请求报头允许客户端向服务器传递请求的附加信息和客户端自身的信息。

>  PS: 客户端不一定特指浏览器，有时候也可使用Linux下的CURL命令以及HTTP客户端测试工具等。

常见的请求报头有: `Acce pt, Accept-Charset, Accept-Encoding, Accept-Language, Content-Type, Authorization, Cookie, User-Agent`等。

* `Accept`用于指定客户端用于接受哪些类型的信息。
* `Accept-Encoding`与`Accept`类似，它用于指定接受的编码方式。
* `Connection`设置为`Keep-alive`用于告诉客户端本次`HTTP`请求结束之后并不需要关闭`TCP`连接，这样可以使下次`HTTP`请求使用相同的`TCP`通道，节省`TCP`连接建立的时间。

###  3.3 请求正文

当使用`POST`, `PUT`等方法时，通常需要客户端向服务器传递数据。这些数据就储存在请求正文中。在请求包头中有一些与请求正文相关的信息，例如: 现在的`Web`应用通常采用`Rest`架构，请求的数据格式一般为`json`。这时就需要设置`Content-Type: application/json`。

##  4. 服务器处理请求并返回HTTP报文(后端 HTTP)

后端从在固定的端口接收到`TCP`报文开始，这一部分对应于编程语言中的`socket`。它会对`TCP`连接进行处理，对`HTTP`协议进行解析，并按照报文格式进一步封装成`HTTP Request`对象，供上层使用。这一部分工作一般是由`Web`服务器去进行，如`Tomcat`,` Jetty`和`Netty`等等。

`HTTP`响应报文也是由三部分组成: **状态码**, **响应报头**和**响应报文**。

###  4.1 状态码

状态码是由3位数组成，第一个数字定义了响应的类别，且有五种可能取值:

- `1xx`：指示信息–表示请求已接收，继续处理。
- `2xx`：成功–表示请求已被成功接收、理解、接受。
- `3xx`：重定向–要完成请求必须进行更进一步的操作。
- `4xx`：客户端错误–请求有语法错误或请求无法实现。
- `5xx`：服务器端错误–服务器未能实现合法的请求。

平时遇到比较常见的状态码有:

* `200 OK` :正常返回信息。
* `400 Bad Rqquest`：客户端请求有语法错误，不能被服务器理解。
* `401 Unauthorized`：请求未经授权，这个状态代码和WWW-Authenticate报头域一起使用。
* `403 Forbidden`：服务器收到请求，但是拒绝提供服务。
* `404 Not Found`：请求资源不存在，比如输入了错误的URL。
* `500 Internal Server Error`：服务器发生了不可预期的错误。
* `503 Server Unavailable`：服务器当前不能处理客户端的请求，一段时间后可能恢复正常。

####  4.1.1  301 和 302 有什么区别？

`301`和`302`状态码都表示重定向，就是说浏览器在拿到服务器返回的这个状态码后会自动跳转到一个新的`URL`地址，这个地址可以从响应的`Location`首部中获取（用户看到的效果就是他输入的地址A瞬间变成了另一个地址B）——这是它们的共同点。

他们的不同在于:

* `301`表示旧地址`A`的资源已经被永久地移除了（这个资源不可访问了），搜索引擎在抓取新内容的同时也将旧的网址交换为重定向之后的网址。
* `302`表示旧地址A的资源还在（仍然可以访问），这个重定向只是临时地从旧地址`A`跳转到地址`B`，搜索引擎会抓取新的内容而保存旧的网址。

###  4.2 响应报头

常见的响应报头字段有: `Server`,` Connection`。

###  4.3 响应报文

服务器返回给浏览器的文本信息，通常`HTML`,` CSS`,` JS`, 图片等文件就放在这一部分。

##  5. 浏览器解析渲染页面

客户端浏览器解析HTML内容，这部分暂时没有深入学习。

##  6. 连接结束 (四次挥手)

具体过程可参考：[TCP 的四次挥手]()

